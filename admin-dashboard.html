<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon.png?v=1">
  <title>Admin Dashboard - BlueLeafBooks</title>
  <link rel="stylesheet" href="./css/style.css">
</head>
<body>
  <header>
    <nav>
      <a href="index.html" class="logo">BlueLeafBooks</a>
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
      </ul>
    </nav>
  </header>

  <div class="container">
    <div class="dashboard">
      <div class="dashboard-sidebar">
        <h3>Admin Panel</h3>
        <ul>
          <li><a href="#" onclick="showSection('overview', event); return false;" class="active">Overview</a></li>
          <li><a href="#" onclick="showSection('books', event); return false;">All Books</a></li>
          <li><a href="#" onclick="showSection('authors', event); return false;">Authors</a></li>
          <li><a href="#" onclick="showSection('orders', event); return false;">Orders</a></li>
          <li><a href="#" onclick="showSection('payouts', event); return false;">Payouts</a></li>
          <li><a href="#" onclick="showSection('coupons', event); return false;">Discount Codes</a></li>
        </ul>
      </div>

      <div class="dashboard-content">
        <div id="dashboard-content">
          <p class="loading">Loading...</p>
        </div>
      </div>
    </div>
  </div>

  <script src="./js/api.js"></script>
  <script src="./js/auth.js"></script>
  <script src="./js/dashboard.js"></script>

  <script>
    // Enforce auth/role
    requireAuth();
    requireRole('admin');

    let currentSection = 'overview';

    // Helper: cover image URL (online-safe)
    function getCoverUrl(book) {
      // If you already store full URLs (Cloudinary), use them directly
      if (book.coverImage && (book.coverImage.startsWith('http://') || book.coverImage.startsWith('https://'))) {
        return book.coverImage;
      }
      // Otherwise fallback to backend host
      return `${API_BASE_URL.replace('/api','')}/${book.coverImage || ''}`;
    }

    async function showSection(section, e) {
      currentSection = section;

      // Update active link
      document.querySelectorAll('.dashboard-sidebar a').forEach(a => a.classList.remove('active'));
      if (e && e.target) e.target.classList.add('active');

      const container = document.getElementById('dashboard-content');
      container.innerHTML = '<p class="loading">Loading...</p>';

      try {
        if (section === 'overview') {
          await loadAdminDashboard();
        } else if (section === 'books') {
          await loadAllBooks();
        } else if (section === 'authors') {
          await loadAllAuthors();
        } else if (section === 'orders') {
          await loadAllOrders();
        } else if (section === 'payouts') {
          await loadPayouts();
        } else if (section === 'coupons') {
          await loadCoupons();
        }
      } catch (error) {
        container.innerHTML = `<p class="alert alert-error">Error: ${error.message}</p>`;
      }
    }

    async function loadAllBooks() {
      const books = await adminAPI.getAllBooks('all');
      const container = document.getElementById('dashboard-content');

      container.innerHTML = `
        <h2>All Books</h2>
        <select id="book-status-filter" onchange="filterBooks()" style="margin-bottom: 1rem; padding: 0.5rem;">
          <option value="all">All Status</option>
          <option value="pending">Pending</option>
          <option value="approved">Approved</option>
          <option value="rejected">Rejected</option>
        </select>
        <table>
          <thead>
            <tr>
              <th>Cover</th>
              <th>Title</th>
              <th>Author</th>
              <th>Genre</th>
              <th>Price</th>
              <th>Status</th>
              <th>Sales</th>
              <th>Featured</th>
              <th>Order</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${books.map(book => `
              <tr>
                <td>
                  <img
                    src="${getCoverUrl(book)}"
                    alt="${book.title}"
                    style="width: 50px; height: 60px; object-fit: cover;"
                    onerror="this.src='https://via.placeholder.com/50x60?text=No+Cover'"
                  >
                </td>
                <td>${book.title}</td>
                <td>${book.author?.name || 'Unknown'}</td>
                <td>${book.genre}</td>
                <td>$${Number(book.price || 0).toFixed(2)}</td>
                <td>
                  <span style="padding: 0.3rem 0.6rem; border-radius: 3px; font-size: 0.85rem;
                    background-color: ${book.isDeleted ? '#e2e3e5' : (book.status === 'approved' ? '#d4edda' : book.status === 'pending' ? '#fff3cd' : '#f8d7da')};
                    color: ${book.isDeleted ? '#6c757d' : (book.status === 'approved' ? '#155724' : book.status === 'pending' ? '#856404' : '#721c24')};">
                    ${book.isDeleted ? 'Deleted' : (book.status ? (book.status.charAt(0).toUpperCase() + book.status.slice(1)) : 'Unknown')}
                  </span>
                </td>
                <td>${book.salesCount || 0}</td>
                <td>
                  <label style="display:flex; align-items:center; gap:0.4rem;">
                    <input type="checkbox" id="feat-${book._id}" ${book.isFeatured ? 'checked' : ''} onchange="updateFeatured('${book._id}')" />
                    <span style="font-size:0.9rem; color:#555;">Featured</span>
                  </label>
                </td>
                <td>
                  <input type="number" min="0" step="1" id="featOrder-${book._id}" value="${Number(book.featuredOrder || 0)}" style="width:80px; padding:0.35rem;" onchange="updateFeatured('${book._id}')" />
                </td>
                <td>
                  ${!book.isDeleted && book.status === 'pending' ? `
                    <button class="btn btn-success btn-small" onclick="approveBook('${book._id}')">Approve</button>
                    <button class="btn btn-danger btn-small" onclick="rejectBook('${book._id}')">Reject</button>
                  ` : ''}
                  ${!book.isDeleted ? `
                    <button class="btn btn-danger btn-small" onclick="adminDeleteBook('${book._id}')" style="margin-left: 0.25rem;">Delete</button>
                  ` : ''}
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    async function filterBooks() {
      const status = document.getElementById('book-status-filter').value;
      await adminAPI.getAllBooks(status === 'all' ? null : status);
      // keep it simple: reload (your original behavior)
      loadAllBooks();
    }

    async function adminDeleteBook(bookId) {
      if (!confirm('Are you sure you want to delete this book from the platform? Existing buyers will still keep access.')) {
        return;
      }

      try {
        await adminAPI.deleteBook(bookId);
        alert('Book deleted successfully');
        if (currentSection === 'books') {
          loadAllBooks();
        } else {
          loadAdminDashboard();
        }
      } catch (error) {
        alert('Error deleting book: ' + error.message);
      }
    }

    async function loadAllAuthors() {
      const container = document.getElementById('dashboard-content');

      // Default: previous month (YYYY-MM)
      const now = new Date();
      const prev = new Date(now.getFullYear(), now.getMonth() - 1, 1);
      const defaultPeriod = `${prev.getFullYear()}-${String(prev.getMonth() + 1).padStart(2, '0')}`;

      const [authors, feeData] = await Promise.all([
        adminAPI.getAllAuthors(),
        adminAPI.getFeeStatus(defaultPeriod)
      ]);

      const rows = (feeData && feeData.rows) ? feeData.rows : [];
      const feePct = feeData && feeData.feePercentage ? feeData.feePercentage : 10;

      container.innerHTML = `
        <h2>All Authors</h2>

        <div style="margin: 1rem 0 2rem 0; background: var(--white); padding: 1rem; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.08);">
          <h3 style="margin-bottom: 0.5rem;">Manual Platform Fee Status</h3>
          <p style="color:#666; margin-bottom:0.75rem; font-size:0.95rem;">
            Authors pay the platform fee manually. Use this table to track who has paid for each month and block/unblock if needed.
          </p>

          <div style="display:flex; flex-wrap:wrap; gap:0.75rem; align-items:flex-end;">
            <div class="form-group" style="max-width: 220px;">
              <label for="admin-fee-period">Period (YYYY-MM)</label>
              <input type="month" id="admin-fee-period" value="${defaultPeriod}">
            </div>
            <button class="btn btn-primary" onclick="loadFeeStatusForPeriod()">Load</button>
            <div style="margin-left:auto; color:#666; font-size:0.95rem;">
              Fee: <strong id="admin-fee-pct">${feePct}%</strong> • Due date: <strong id="admin-fee-duedate">${new Date(feeData.dueDate).toLocaleDateString()}</strong>
            </div>
          </div>

          <div id="admin-fee-alert" style="margin-top:0.75rem;"></div>

          <div style="overflow:auto; margin-top: 1rem;">
            <table>
              <thead>
                <tr>
                  <th>Author</th>
                  <th>Gross Sales</th>
                  <th>Platform Fee Due</th>
                  <th>Paid?</th>
                  <th>Paid At</th>
                  <th>Overdue</th>
                  <th>Blocked</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="admin-fee-tbody">
                ${rows.map(r => `
                  <tr>
                    <td>
                      <strong>${r.name}</strong><br/>
                      <span style="color:#666; font-size:0.9rem;">${r.email}</span>
                    </td>
                    <td>$${Number(r.grossSales || 0).toFixed(2)}</td>
                    <td>$${Number(r.platformFeeDue || 0).toFixed(2)}</td>
                    <td>
                      ${r.isPaid
                        ? '<span class="badge badge-success">PAID</span>'
                        : '<span class="badge badge-warning">UNPAID</span>'}
                    </td>
                    <td>${r.paidAt ? new Date(r.paidAt).toLocaleDateString() : '<span style="color:#999;">—</span>'}</td>
                    <td>${r.isOverdue ? '<span class="badge badge-danger">OVERDUE</span>' : '<span style="color:#999;">—</span>'}</td>
                    <td>${r.isBlocked ? '<span class="badge badge-danger">YES</span>' : '<span class="badge badge-success">NO</span>'}</td>
                    <td style="min-width:260px;">
                      ${r.isPaid
                        ? `<button class="btn btn-secondary" onclick="markAuthorUnpaid('${r.authorId}')">Mark Unpaid</button>`
                        : `<button class="btn btn-primary" onclick="markAuthorPaid('${r.authorId}')">Mark Paid</button>`}
              ${r.isBlocked
                ? `<button class="btn btn-secondary" style="margin-left:6px;" onclick="unblockAuthor('${r.authorId}')">Unblock</button>`
                : `<button class="btn btn-danger" style="margin-left:6px;" onclick="blockAuthorPrompt('${r.authorId}')">Block</button>`}
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>

        <div style="margin: 1rem 0 2rem 0; background: var(--white); padding: 1rem; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.08);">
          <h3 style="margin-bottom: 0.5rem;">Monthly Reports</h3>
          <p style="color:#666; margin-bottom:0.75rem; font-size:0.95rem;">
            Download monthly earnings PDFs for any author to verify sales, platform fees, and their net income.
          </p>
          <div id="admin-author-reports-alert"></div>
          <div style="display:flex; flex-wrap:wrap; gap:0.75rem; align-items:flex-end;">
            <div class="form-group" style="min-width: 200px;">
              <label for="admin-report-author">Author</label>
              <select id="admin-report-author">
                ${authors.map(author => `
                  <option value="${author._id}">${author.name} (${author.email})</option>
                `).join('')}
              </select>
            </div>
            <div class="form-group" style="max-width: 120px;">
              <label for="admin-report-month">Month</label>
              <select id="admin-report-month">
                ${[1,2,3,4,5,6,7,8,9,10,11,12].map(m => {
                  const selected = (m === (now.getMonth() + 1)) ? 'selected' : '';
                  return `<option value="${m}" ${selected}>${m}</option>`;
                }).join('')}
              </select>
            </div>
            <div class="form-group" style="max-width: 140px;">
              <label for="admin-report-year">Year</label>
              <input type="number" id="admin-report-year" min="2000" max="2100" value="${now.getFullYear()}" />
            </div>
            <button class="btn btn-primary" onclick="downloadAdminAuthorMonthlyReport()">Download PDF</button>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>PayPal Payout Email</th>
              <th>Joined</th>
            </tr>
          </thead>
          <tbody>
            ${authors.map(author => `
              <tr>
                <td>${author.name}</td>
                <td>${author.email}</td>
                <td>${author.payoutPaypalEmail || '<span style="color: #999;">Not set</span>'}</td>
                <td>${new Date(author.createdAt).toLocaleDateString()}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    async function loadFeeStatusForPeriod() {
      const alertEl = document.getElementById('admin-fee-alert');
      if (alertEl) alertEl.innerHTML = '';
      const periodInput = document.getElementById('admin-fee-period');
      const period = periodInput ? periodInput.value : '';
      try {
        const feeData = await adminAPI.getFeeStatus(period);
        const tbody = document.getElementById('admin-fee-tbody');
        if (!tbody) return;

        const rows = feeData.rows || [];
        tbody.innerHTML = rows.map(r => `
          <tr>
            <td>
              <strong>${r.name}</strong><br/>
              <span style="color:#666; font-size:0.9rem;">${r.email}</span>
            </td>
            <td>$${Number(r.grossSales || 0).toFixed(2)}</td>
            <td>$${Number(r.platformFeeDue || 0).toFixed(2)}</td>
            <td>
              ${r.isPaid
                ? '<span class="badge badge-success">PAID</span>'
                : '<span class="badge badge-warning">UNPAID</span>'}
            </td>
            <td>${r.paidAt ? new Date(r.paidAt).toLocaleDateString() : '<span style="color:#999;">—</span>'}</td>
            <td>${r.isOverdue ? '<span class="badge badge-danger">OVERDUE</span>' : '<span style="color:#999;">—</span>'}</td>
            <td>${r.isBlocked ? '<span class="badge badge-danger">YES</span>' : '<span class="badge badge-success">NO</span>'}</td>
            <td style="min-width:260px;">
              ${r.isPaid
                ? `<button class="btn btn-secondary" onclick="markAuthorUnpaid('${r.authorId}')">Mark Unpaid</button>`
                : `<button class="btn btn-primary" onclick="markAuthorPaid('${r.authorId}')">Mark Paid</button>`}
              ${r.isBlocked
                ? `<button class="btn btn-secondary" style="margin-left:6px;" onclick="unblockAuthor('${r.authorId}')">Unblock</button>`
                : `<button class="btn btn-danger" style="margin-left:6px;" onclick="blockAuthorPrompt('${r.authorId}')">Block</button>`}
            </td>
          </tr>
        `).join('');

        const pctEl = document.getElementById('admin-fee-pct');
        if (pctEl) pctEl.textContent = `${feeData.feePercentage}%`;
        const dueEl = document.getElementById('admin-fee-duedate');
        if (dueEl) dueEl.textContent = new Date(feeData.dueDate).toLocaleDateString();

      } catch (error) {
        if (alertEl) alertEl.innerHTML = `<div class="alert alert-error">${error.message}</div>`;
      }
    }

    async function markAuthorPaid(authorId) {
      const period = document.getElementById('admin-fee-period')?.value || '';
      const note = prompt('Optional note (e.g., PayPal transaction ID):') || '';
      try {
        await adminAPI.markFeePaid(authorId, period, note);
        const alertEl = document.getElementById('admin-fee-alert');
        if (alertEl) alertEl.innerHTML = `<div class="alert alert-success">Marked as PAID.</div>`;
        await loadFeeStatusForPeriod();
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    async function markAuthorUnpaid(authorId) {
      const period = document.getElementById('admin-fee-period')?.value || '';
      const note = prompt('Optional note (e.g., reason):') || '';
      try {
        await adminAPI.markFeeUnpaid(authorId, period, note);
        const alertEl = document.getElementById('admin-fee-alert');
        if (alertEl) alertEl.innerHTML = `<div class="alert alert-success">Marked as UNPAID.</div>`;
        await loadFeeStatusForPeriod();
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }


    async function downloadAdminAuthorMonthlyReport() {
      const alertContainer = document.getElementById('admin-author-reports-alert');
      if (alertContainer) alertContainer.innerHTML = '';

      const authorId = document.getElementById('admin-report-author')?.value;
      const month = parseInt(document.getElementById('admin-report-month')?.value || '', 10);
      const year = parseInt(document.getElementById('admin-report-year')?.value || '', 10);

      if (!authorId || !month || !year) {
        const msg = 'Please select an author, month, and year.';
        alertContainer.innerHTML = `<div class="alert alert-error">${msg}</div>`;
        return;
      }

      try {
        const token = getAuthToken();
        const response = await fetch(`${API_BASE_URL}/admin/reports/authors/${authorId}/${year}/${month}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          const text = await response.text();
          throw new Error(text || 'Failed to generate report');
        }

        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        const monthPadded = String(month).padStart(2, '0');
        link.href = url;
        link.download = `blueleafbooks-earnings-${authorId}-${year}-${monthPadded}.pdf`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      } catch (error) {
        alertContainer.innerHTML = `<div class="alert alert-error">${error.message || 'Error downloading report'}</div>`;
      }
    }

    async function loadAllOrders() {
      const orders = await adminAPI.getAllOrders();
      const container = document.getElementById('dashboard-content');

      container.innerHTML = `
        <h2>All Orders</h2>

        <div style="margin: 1rem 0 2rem 0; background: var(--white); padding: 1rem; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.08);">
          <h3 style="margin-bottom: 0.5rem;">Monthly Platform Report</h3>
          <p style="color:#666; margin-bottom:0.75rem; font-size:0.95rem;">
            Download a monthly PDF report showing all authors and all sales for the selected period, including platform fees and author earnings.
          </p>
          <div id="admin-platform-reports-alert"></div>
          <div style="display:flex; flex-wrap:wrap; gap:0.75rem; align-items:flex-end;">
            <div class="form-group" style="max-width: 120px;">
              <label for="admin-platform-month">Month</label>
              <select id="admin-platform-month">
                ${[1,2,3,4,5,6,7,8,9,10,11,12].map(m => {
                  const now = new Date();
                  const selected = (m === (now.getMonth() + 1)) ? 'selected' : '';
                  return `<option value="${m}" ${selected}>${m}</option>`;
                }).join('')}
              </select>
            </div>
            <div class="form-group" style="max-width: 140px;">
              <label for="admin-platform-year">Year</label>
              <input type="number" id="admin-platform-year" min="2000" max="2100" value="${new Date().getFullYear()}" />
            </div>
            <button class="btn btn-primary" onclick="downloadAdminPlatformMonthlyReport()">Download Platform PDF</button>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Customer</th>
              <th>Items</th>
              <th>Total</th>
              <th>Platform Earnings</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            ${orders.map(order => `
              <tr>
                <td>${order._id?.substring(0, 8) || ''}...</td>
                <td>${order.customer?.name || 'Unknown'}</td>
                <td>${order.items?.length || 0} book(s)</td>
                <td>$${Number(order.totalAmount || 0).toFixed(2)}</td>
                <td>$${Number(order.platformEarnings || 0).toFixed(2)}</td>
                <td>${order.createdAt ? new Date(order.createdAt).toLocaleDateString() : '-'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    async function downloadAdminPlatformMonthlyReport() {
      const alertContainer = document.getElementById('admin-platform-reports-alert');
      if (alertContainer) alertContainer.innerHTML = '';

      const month = parseInt(document.getElementById('admin-platform-month')?.value || '', 10);
      const year = parseInt(document.getElementById('admin-platform-year')?.value || '', 10);

      if (!month || !year) {
        alertContainer.innerHTML = `<div class="alert alert-error">Please select a valid month and year.</div>`;
        return;
      }

      try {
        const token = getAuthToken();
        const response = await fetch(`${API_BASE_URL}/admin/reports/monthly/${year}/${month}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          const text = await response.text();
          throw new Error(text || 'Failed to generate report');
        }

        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        const monthPadded = String(month).padStart(2, '0');
        link.href = url;
        link.download = `blueleafbooks-platform-earnings-${year}-${monthPadded}.pdf`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      } catch (error) {
        alertContainer.innerHTML = `<div class="alert alert-error">${error.message || 'Error downloading report'}</div>`;
      }
    }

    async function loadPayouts() {
      const payouts = await adminAPI.getPayouts();
      const container = document.getElementById('dashboard-content');

      container.innerHTML = `
        <h2>Author Payouts</h2>
        <p class="alert alert-info">Unpaid earnings for authors. Mark as paid after processing monthly payouts.</p>
        <table>
          <thead>
            <tr>
              <th>Author</th>
              <th>Email</th>
              <th>PayPal Payout Email</th>
              <th>Unpaid Earnings</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${payouts.length === 0 ? '<tr><td colspan="5">No unpaid earnings</td></tr>' : payouts.map(payout => `
              <tr>
                <td>${payout.author?.name || '-'}</td>
                <td>${payout.author?.email || '-'}</td>
                <td>${payout.author?.payoutPaypalEmail || '<span style="color: #999;">Not set</span>'}</td>
                <td>$${Number(payout.unpaidEarnings || 0).toFixed(2)}</td>
                <td>
                  <button class="btn btn-success btn-small" onclick="markPayoutPaid('${payout.author?.id}', ${payout.unpaidEarnings})">
                    Mark as Paid
                  </button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    async function markPayoutPaid(authorId, amount) {
      if (!confirm(`Mark $${amount} as paid for this author?`)) return;

      try {
        const period = new Date().toISOString().slice(0, 7); // YYYY-MM
        await adminAPI.markPayoutPaid({ authorId, amount: parseFloat(amount), period });
        alert('Payout marked as paid');
        loadPayouts();
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // Coupons section - unchanged logic from your code
    // (kept as-is)
    async function loadCoupons() {
      try {
        const [coupons, authors] = await Promise.all([
          adminAPI.getAllCoupons(),
          adminAPI.getAllAuthors()
        ]);

        const container = document.getElementById('dashboard-content');

        container.innerHTML = `
          <h2>Discount Codes</h2>
          <button class="btn btn-primary" onclick="showCreateCouponForm()" style="margin-bottom: 1rem;">Create New Coupon</button>

          <div id="create-coupon-form" style="display: none; background: var(--white); padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h3>Create New Coupon</h3>
            <div id="create-coupon-alert"></div>
            <div class="form-group">
              <label>Code *</label>
              <input type="text" id="new-coupon-code" placeholder="e.g., SAVE20" required>
            </div>
            <div class="form-group">
              <label>Discount Percentage * (1-100)</label>
              <input type="number" id="new-coupon-percentage" min="1" max="100" required>
            </div>
            <div class="form-group">
              <label>Scope *</label>
              <select id="new-coupon-scope" onchange="toggleAuthorSelect()" required>
                <option value="all">All Books</option>
                <option value="author">Specific Author</option>
              </select>
            </div>
            <div class="form-group" id="author-select-group" style="display: none;">
              <label>Author *</label>
              <select id="new-coupon-author">
                <option value="">Select Author</option>
                ${authors.map(author => `<option value="${author._id}">${author.name} (${author.email})</option>`).join('')}
              </select>
            </div>
            <div class="form-group">
              <label>Valid From (optional)</label>
              <input type="datetime-local" id="new-coupon-validFrom">
            </div>
            <div class="form-group">
              <label>Valid To (optional)</label>
              <input type="datetime-local" id="new-coupon-validTo">
            </div>
            <button class="btn btn-primary" onclick="createCoupon()">Create Coupon</button>
            <button class="btn btn-secondary" onclick="hideCreateCouponForm()" style="margin-left: 0.5rem;">Cancel</button>
          </div>

          <table>
            <thead>
              <tr>
                <th>Code</th>
                <th>Discount %</th>
                <th>Scope</th>
                <th>Author</th>
                <th>Status</th>
                <th>Valid From</th>
                <th>Valid To</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${coupons.length === 0 ? '<tr><td colspan="8">No coupons created yet</td></tr>' : coupons.map(coupon => `
                <tr>
                  <td><strong>${coupon.code}</strong></td>
                  <td>${coupon.discountPercentage}%</td>
                  <td>${coupon.scope === 'author' ? 'Author' : 'All'}</td>
                  <td>${coupon.author ? coupon.author.name : '-'}</td>
                  <td>
                    <span style="padding: 0.3rem 0.6rem; border-radius: 3px; font-size: 0.85rem;
                      background-color: ${coupon.isActive ? '#d4edda' : '#f8d7da'};
                      color: ${coupon.isActive ? '#155724' : '#721c24'};">
                      ${coupon.isActive ? 'Active' : 'Inactive'}
                    </span>
                  </td>
                  <td>${coupon.validFrom ? new Date(coupon.validFrom).toLocaleDateString() : '-'}</td>
                  <td>${coupon.validTo ? new Date(coupon.validTo).toLocaleDateString() : '-'}</td>
                  <td>
                    <button class="btn btn-secondary btn-small" onclick="toggleCouponStatus('${coupon._id}')">
                      ${coupon.isActive ? 'Deactivate' : 'Activate'}
                    </button>
                    <button class="btn btn-danger btn-small" onclick="deleteCoupon('${coupon._id}')" style="margin-left: 0.5rem;">Delete</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (error) {
        document.getElementById('dashboard-content').innerHTML =
          `<p class="alert alert-error">Error loading coupons: ${error.message}</p>`;
      }
    }

    function showCreateCouponForm() {
      document.getElementById('create-coupon-form').style.display = 'block';
    }

    function hideCreateCouponForm() {
      document.getElementById('create-coupon-form').style.display = 'none';
      document.getElementById('create-coupon-alert').innerHTML = '';
      document.getElementById('new-coupon-code').value = '';
      document.getElementById('new-coupon-percentage').value = '';
      document.getElementById('new-coupon-scope').value = 'all';
      document.getElementById('new-coupon-author').value = '';
      document.getElementById('new-coupon-validFrom').value = '';
      document.getElementById('new-coupon-validTo').value = '';
      document.getElementById('author-select-group').style.display = 'none';
    }

    function toggleAuthorSelect() {
      const scope = document.getElementById('new-coupon-scope').value;
      const authorGroup = document.getElementById('author-select-group');
      if (scope === 'author') {
        authorGroup.style.display = 'block';
      } else {
        authorGroup.style.display = 'none';
        document.getElementById('new-coupon-author').value = '';
      }
    }

    async function createCoupon() {
      const alertContainer = document.getElementById('create-coupon-alert');
      alertContainer.innerHTML = '';

      const code = document.getElementById('new-coupon-code').value.trim();
      const discountPercentage = document.getElementById('new-coupon-percentage').value;
      const scope = document.getElementById('new-coupon-scope').value;
      const author = document.getElementById('new-coupon-author').value;
      const validFrom = document.getElementById('new-coupon-validFrom').value;
      const validTo = document.getElementById('new-coupon-validTo').value;

      if (!code || !discountPercentage) {
        alertContainer.innerHTML = '<div class="alert alert-error">Code and discount percentage are required</div>';
        return;
      }

      if (scope === 'author' && !author) {
        alertContainer.innerHTML = '<div class="alert alert-error">Please select an author</div>';
        return;
      }

      try {
        const couponData = {
          code,
          discountPercentage: parseFloat(discountPercentage),
          scope
        };

        if (scope === 'author') couponData.author = author;
        if (validFrom) couponData.validFrom = validFrom;
        if (validTo) couponData.validTo = validTo;

        await adminAPI.createCoupon(couponData);
        alert('Coupon created successfully!');
        hideCreateCouponForm();
        loadCoupons();
      } catch (error) {
        alertContainer.innerHTML = `<div class="alert alert-error">${error.message}</div>`;
      }
    }

    async function toggleCouponStatus(couponId) {
      try {
        await adminAPI.toggleCoupon(couponId);
        loadCoupons();
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    async function deleteCoupon(couponId) {
      if (!confirm('Are you sure you want to delete this coupon? This action cannot be undone.')) return;
      try {
        await adminAPI.deleteCoupon(couponId);
        alert('Coupon deleted successfully');
        loadCoupons();
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadAdminDashboard();
    });
  </script>
</body>
</html>
