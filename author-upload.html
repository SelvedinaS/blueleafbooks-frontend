<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon.png?v=1">
  <title>Upload Book - BlueLeafBooks</title>
  <link rel="stylesheet" href="./css/style.css">
</head>
<body>
  <header>
    <nav>
      <a href="index.html" class="logo">BlueLeafBooks</a>
      <button class="menu-btn" aria-label="Open menu" aria-expanded="false">☰</button>
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a href="author-dashboard.html">Dashboard</a></li>
        <li><a href="support.html">Support</a></li>
      </ul>
    </nav>
  </header>

  <div class="container">
    <div class="form-container" style="max-width: 700px;">
      <h2 id="form-title">Upload New Book</h2>
      <div id="alert-container"></div>

      <div id="paypal-section" class="form-group" style="background:#f8f9fa;padding:1rem;border-radius:8px;margin-bottom:1.5rem;">
        <label><strong>PayPal email (required for publishing)</strong></label>
        <p class="muted" style="font-size:0.9rem;margin:0.25rem 0 0.5rem 0;">Earnings are sent to this address. You must set it before publishing books. You can also change it in <a href="author-dashboard.html">Dashboard → Payout Settings</a>.</p>
        <div style="display:flex;gap:0.5rem;flex-wrap:wrap;align-items:center;">
          <input type="email" id="paypal-email" placeholder="your-paypal@email.com" style="flex:1;min-width:200px;padding:0.5rem;">
          <button type="button" id="save-paypal-btn" class="btn btn-secondary">Save PayPal</button>
        </div>
        <div id="paypal-alert" style="margin-top:0.5rem;"></div>
      </div>

      <form id="book-form" enctype="multipart/form-data">
        <div class="form-group">
          <label for="title">Title</label>
          <input type="text" id="title" name="title" required>
        </div>

        <div class="form-group">
          <label for="description">Description</label>
          <textarea id="description" name="description" required></textarea>
        </div>

        <div class="form-group">
          <label for="genre">Genre</label>
          <input type="text" id="genre" name="genre" required placeholder="e.g., Fiction, Science Fiction, Mystery">
        </div>

        <div class="form-group">
          <label for="price">Price (USD)</label>
          <input type="number" id="price" name="price" step="0.01" min="0" required>
        </div>

        <div class="form-group">
          <label for="coverImage">Cover Image</label>
          <input type="file" id="coverImage" name="coverImage" accept="image/*">
        </div>

        <div class="form-group">
          <label for="pdfFile">PDF File</label>
          <input type="file" id="pdfFile" name="pdfFile" accept=".pdf">
        </div>

        <button type="submit" class="btn btn-primary" style="width: 100%;" disabled title="Set your PayPal email above to publish books">Submit Book</button>
      </form>
    </div>
  </div>

  <script src="./js/api.js"></script>
  <script src="./js/auth.js"></script>
  <script src="./js/books.js"></script>
  <script>
    requireAuth();
    requireRole('author');

    let hasPaypal = false;

    document.addEventListener('DOMContentLoaded', () => {
      const menuBtn = document.querySelector('.menu-btn');
      const nav = document.querySelector('.nav-links');
      if (menuBtn && nav) {
        menuBtn.addEventListener('click', () => { nav.classList.toggle('open'); menuBtn.setAttribute('aria-expanded', nav.classList.contains('open') ? 'true' : 'false'); });
      }
      const urlParams = new URLSearchParams(window.location.search);
      const bookId = urlParams.get('id');
      const isEditMode = !!bookId;

      loadPaypalSettings();
      document.getElementById('save-paypal-btn').addEventListener('click', savePaypalSettings);

      if (isEditMode) {
        document.getElementById('form-title').textContent = 'Edit Book';
        loadBookForEdit(bookId);
      }

      async function loadPaypalSettings() {
        try {
          const s = await authorsAPI.getPayoutSettings();
          const email = (s?.payoutPaypalEmail || '').trim();
          hasPaypal = !!email;
          document.getElementById('paypal-email').value = email;
          updateSubmitState();
        } catch (e) {
          document.getElementById('paypal-alert').innerHTML = '<span class="alert alert-error">Could not load PayPal settings.</span>';
        }
      }

      async function savePaypalSettings() {
        const input = document.getElementById('paypal-email');
        const alertEl = document.getElementById('paypal-alert');
        const email = (input.value || '').trim();
        if (email) {
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(email)) {
            alertEl.innerHTML = '<span class="alert alert-error">Invalid email format.</span>';
            return;
          }
        }
        try {
          await authorsAPI.updatePayoutSettings({ payoutPaypalEmail: email || null });
          hasPaypal = !!email;
          alertEl.innerHTML = '<span class="alert alert-success">PayPal saved!</span>';
          updateSubmitState();
          setTimeout(() => { alertEl.innerHTML = ''; }, 3000);
        } catch (e) {
          alertEl.innerHTML = '<span class="alert alert-error">' + (e.message || 'Failed to save') + '</span>';
        }
      }

      function updateSubmitState() {
        const btn = document.querySelector('#book-form button[type="submit"]');
        if (hasPaypal) {
          btn.disabled = false;
          btn.title = '';
        } else {
          btn.disabled = true;
          btn.title = 'Set your PayPal email above to publish books';
        }
      }

      async function loadBookForEdit(id) {
        try {
          const book = await booksAPI.getById(id);
          document.getElementById('title').value = book.title;
          document.getElementById('description').value = book.description;
          document.getElementById('genre').value = book.genre;
          document.getElementById('price').value = book.price;
        } catch (error) {
          alert('Error loading book: ' + error.message);
          window.location.href = 'author-dashboard.html';
        }
      }

      document.getElementById('book-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!hasPaypal) {
          document.getElementById('alert-container').innerHTML = '<div class="alert alert-error">You must set your PayPal email before publishing. Enter it above and click Save PayPal.</div>';
          return;
        }

        const alertContainer = document.getElementById('alert-container');
        alertContainer.innerHTML = '';

        const formData = new FormData();
        formData.append('title', document.getElementById('title').value);
        formData.append('description', document.getElementById('description').value);
        formData.append('genre', document.getElementById('genre').value);
        formData.append('price', document.getElementById('price').value);

        const coverFile = document.getElementById('coverImage').files[0];
        const pdfFile = document.getElementById('pdfFile').files[0];

        if (isEditMode) {
          if (coverFile) formData.append('coverImage', coverFile);
          if (pdfFile) formData.append('pdfFile', pdfFile);
        } else {
          if (!coverFile || !pdfFile) {
            alertContainer.innerHTML = '<div class="alert alert-error">Cover image and PDF file are required</div>';
            return;
          }
          formData.append('coverImage', coverFile);
          formData.append('pdfFile', pdfFile);
        }

        try {
          if (isEditMode) {
            await booksAPI.update(bookId, formData);
            alert('Book updated successfully! It is now live on the store.');
          } else {
            await booksAPI.create(formData);
            alert('Book submitted successfully! It is now live on the store.');
          }
          window.location.href = 'author-dashboard.html';
        } catch (error) {
          alertContainer.innerHTML = `<div class="alert alert-error">${error.message}</div>`;
        }
      });
    });
  </script>
</body>
</html>
